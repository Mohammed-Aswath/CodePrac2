/**
 * Batch Questions Management
 * Handles Questions CRUD operations for Batch Admins with inline panel interface
 * 
 * Required fields for question creation:
 * - topic_id (which topic the question belongs to)
 * - title (question title)
 * - description (question description)
 * - sample_input (sample input for testing)
 * - sample_output (expected output for sample input)
 * 
 * Hidden testcases are auto-generated by AI backend
 */

const BatchQuestions = {
  apiEndpoint: `${CONFIG.API_BASE_URL}/batch/questions`,
  topicsEndpoint: `${CONFIG.API_BASE_URL}/batch/topics`,
  editingId: null,
  selectedTopicId: null,
  selectedQuestionId: null,
  allQuestions: [],
  allTopics: [],

  /**
   * Initialize and load all data
   */
  init: async function() {
    await this.loadTopics();
    await this.loadTopicsForForm();
    await this.loadQuestions();
  },

  /**
   * Load topics for left panel
   */
  loadTopics: async function() {
    try {
      const response = await fetch(this.topicsEndpoint, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        const data = await response.json();
        this.allTopics = data.data?.topics || [];
        this.displayTopics();
      }
    } catch (error) {
      console.error('Error loading topics:', error);
    }
  },

  /**
   * Load topics for form dropdown
   */
  loadTopicsForForm: async function() {
    try {
      const response = await fetch(this.topicsEndpoint, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        const data = await response.json();
        const topics = data.data?.topics || [];
        const select = document.getElementById('batchQuestionsFormTopic');
        
        select.innerHTML = '<option value="">-- Select topic --</option>';
        topics.forEach(topic => {
          if (!topic.is_disabled) {
            const option = document.createElement('option');
            option.value = topic.id;
            option.textContent = topic.topic_name;
            select.appendChild(option);
          }
        });
      }
    } catch (error) {
      console.error('Error loading topics for form:', error);
    }
  },

  /**
   * Display topics in left panel
   */
  displayTopics: function() {
    const container = document.getElementById('batchQuestionsTopicPanel');
    
    if (!this.allTopics || this.allTopics.length === 0) {
      container.innerHTML = '<p style="color: #999; text-align: center;">No topics available</p>';
      return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    
    // Add "All" option
    const allClass = !this.selectedTopicId ? 'background-color: #007bff; color: white;' : '';
    html += `<button onclick="BatchQuestions.selectTopic(null)" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; ${allClass}">All Topics</button>`;
    
    this.allTopics.forEach(topic => {
      if (!topic.is_disabled) {
        const isSelected = this.selectedTopicId === topic.id;
        const bgColor = isSelected ? 'background-color: #007bff; color: white;' : '';
        html += `<button onclick="BatchQuestions.selectTopic('${topic.id}')" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: left; ${bgColor}">${this.escapeHtml(topic.topic_name)}</button>`;
      }
    });
    
    html += '</div>';
    container.innerHTML = html;
  },

  /**
   * Select topic and filter questions
   */
  selectTopic: function(topicId) {
    this.selectedTopicId = topicId;
    this.selectedQuestionId = null;
    this.displayTopics();
    this.displayQuestions();
    this.clearQuestionDetail();
  },

  /**
   * Save question inline (create or update)
   */
  saveInline: async function() {
    const questionId = document.getElementById('batchQuestionsFormId').value;
    const topicId = document.getElementById('batchQuestionsFormTopic').value.trim();
    const title = document.getElementById('batchQuestionsFormTitle').value.trim();
    const description = document.getElementById('batchQuestionsFormDescription').value.trim();
    const sampleInput = document.getElementById('batchQuestionsFormSampleInput').value.trim();
    const sampleOutput = document.getElementById('batchQuestionsFormSampleOutput').value.trim();

    // Validation
    if (!topicId) {
      Utils.showMessage('batchQuestionsFormMessage', 'Please select a topic', 'error');
      return;
    }

    if (!title || title.length < 3) {
      Utils.showMessage('batchQuestionsFormMessage', 'Title must be at least 3 characters', 'error');
      return;
    }

    if (!description || description.length < 10) {
      Utils.showMessage('batchQuestionsFormMessage', 'Description must be at least 10 characters', 'error');
      return;
    }

    if (!sampleInput) {
      Utils.showMessage('batchQuestionsFormMessage', 'Sample input is required', 'error');
      return;
    }

    if (!sampleOutput) {
      Utils.showMessage('batchQuestionsFormMessage', 'Sample output is required', 'error');
      return;
    }

    const payload = {
      topic_id: topicId,
      title: title,
      description: description,
      sample_input: sampleInput,
      sample_output: sampleOutput
    };

    try {
      let response;
      if (questionId) {
        response = await fetch(`${this.apiEndpoint}/${questionId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(payload)
        });
      } else {
        response = await fetch(this.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(payload)
        });
      }

      if (response.ok) {
        Utils.showMessage('batchQuestionsFormMessage', questionId ? 'Question updated successfully' : 'Question created successfully', 'success');
        setTimeout(() => {
          this.clearForm();
          this.loadQuestions();
        }, 500);
      } else {
        const error = await response.json();
        Utils.showMessage('batchQuestionsFormMessage', error.message || 'Error saving question', 'error');
      }
    } catch (error) {
      console.error('Error saving question:', error);
      Utils.showMessage('batchQuestionsFormMessage', 'Error saving question: ' + error.message, 'error');
    }
  },

  /**
   * Clear form
   */
  clearForm: function() {
    this.editingId = null;
    document.getElementById('batchQuestionsFormId').value = '';
    document.getElementById('batchQuestionsFormTopic').value = '';
    document.getElementById('batchQuestionsFormTitle').value = '';
    document.getElementById('batchQuestionsFormDescription').value = '';
    document.getElementById('batchQuestionsFormSampleInput').value = '';
    document.getElementById('batchQuestionsFormSampleOutput').value = '';
    document.getElementById('batchQuestionsFormMessage').innerHTML = '';
    document.querySelector('#batchQuestionsListPanel').closest('div').querySelector('button[onclick*="saveInline"]').textContent = 'Create Question';
    document.getElementById('batchQuestionsClearBtn').style.display = 'none';
  },

  /**
   * Load question for editing
   */
  loadQuestionForEdit: function(questionId) {
    const question = this.allQuestions.find(q => q.id === questionId);
    
    if (!question) return;

    this.editingId = questionId;
    document.getElementById('batchQuestionsFormId').value = questionId;
    document.getElementById('batchQuestionsFormTopic').value = question.topic_id;
    document.getElementById('batchQuestionsFormTitle').value = question.title;
    document.getElementById('batchQuestionsFormDescription').value = question.description;
    document.getElementById('batchQuestionsFormSampleInput').value = question.sample_input;
    document.getElementById('batchQuestionsFormSampleOutput').value = question.sample_output;
    document.getElementById('batchQuestionsFormMessage').innerHTML = '';
    
    // Update button text
    const submitBtn = document.querySelector('button[onclick="BatchQuestions.saveInline()"]');
    if (submitBtn) submitBtn.textContent = 'Update Question';
    
    // Show clear button
    document.getElementById('batchQuestionsClearBtn').style.display = 'inline-block';
    
    // Scroll to form
    document.getElementById('batchQuestionsFormTopic').scrollIntoView({ behavior: 'smooth', block: 'start' });
  },

  /**
   * Load all questions for the current batch
   */
  loadQuestions: async function() {
    try {
      const response = await fetch(this.apiEndpoint, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        const data = await response.json();
        this.allQuestions = data.data?.questions || [];
        this.displayQuestions();
      }
    } catch (error) {
      console.error('Error loading questions:', error);
    }
  },

  /**
   * Display questions in middle panel filtered by selected topic
   */
  displayQuestions: function() {
    const container = document.getElementById('batchQuestionsListPanel');
    
    // Filter questions by selected topic
    let filteredQuestions = this.allQuestions;
    if (this.selectedTopicId) {
      filteredQuestions = this.allQuestions.filter(q => q.topic_id === this.selectedTopicId);
    }
    
    if (!filteredQuestions || filteredQuestions.length === 0) {
      container.innerHTML = '<p style="color: #999; text-align: center;">No questions for this topic</p>';
      return;
    }

    let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
    
    filteredQuestions.forEach(question => {
      const isSelected = this.selectedQuestionId === question.id;
      const bgColor = isSelected ? 'background-color: #e7f3ff; border-left: 3px solid #007bff;' : 'border-left: 3px solid transparent;';
      
      html += `<div style="padding: 0.75rem; background: white; border: 1px solid #ddd; border-radius: 4px; ${bgColor}">
                <div style="font-weight: bold; margin-bottom: 0.5rem; cursor: pointer;" onclick="BatchQuestions.selectQuestion('${question.id}')">${this.escapeHtml(question.title)}</div>
                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">${this.escapeHtml(question.description.substring(0, 80))}${question.description.length > 80 ? '...' : ''}</div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-sm" onclick="BatchQuestions.loadQuestionForEdit('${question.id}')" style="flex: 1; font-size: 0.8rem;">Edit</button>
                  <button class="btn btn-sm" onclick="BatchQuestions.viewQuestion('${question.id}')" style="flex: 1; font-size: 0.8rem;">View</button>
                  <button class="btn btn-danger btn-sm" onclick="BatchQuestions.deleteConfirm('${question.id}')" style="flex: 1; font-size: 0.8rem;">Delete</button>
                </div>
              </div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
  },

  /**
   * Select question and show details
   */
  selectQuestion: function(questionId) {
    this.selectedQuestionId = questionId;
    this.displayQuestions();
    this.displayQuestionDetail(questionId);
  },

  /**
   * View question (same as select)
   */
  viewQuestion: function(questionId) {
    this.selectQuestion(questionId);
  },

  /**
   * Display question details in resizable LeetCode-style split layout
   */
  displayQuestionDetail: function(questionId) {
    const question = this.allQuestions.find(q => q.id === questionId);
    
    if (!question) {
      this.clearQuestionDetail();
      return;
    }

    const topicName = this.allTopics.find(t => t.id === question.topic_id)?.topic_name || 'Unknown';
    const hiddenTestcases = question.hidden_testcases || [];
    const self = this;
    
    let detailsHtml = `
      <div style="padding: 1.5rem; overflow-y: auto; height: 100%;">
        <h3 style="margin-top: 0; color: #333;">${this.escapeHtml(question.title)}</h3>
        
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
          <span style="background: #e7f3ff; color: #0056b3; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">Medium</span>
          <span style="background: #fff3cd; color: #856404; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">Topic: ${this.escapeHtml(topicName)}</span>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <h4 style="color: #555; margin-bottom: 0.5rem;">Description</h4>
          <p style="color: #666; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${this.escapeHtml(question.description)}</p>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <h4 style="color: #555; margin-bottom: 0.75rem;">Examples</h4>
          <div style="background: #f5f5f5; border-radius: 4px; padding: 1rem; margin-bottom: 1rem;">
            <div style="margin-bottom: 0.75rem;">
              <strong style="color: #333;">Input:</strong>
              <div style="font-family: monospace; color: #d63031; margin-top: 0.25rem; padding: 0.5rem; background: white; border-radius: 3px; overflow-x: auto;">
                ${this.escapeHtml(question.sample_input)}
              </div>
            </div>
            <div>
              <strong style="color: #333;">Output:</strong>
              <div style="font-family: monospace; color: #27ae60; margin-top: 0.25rem; padding: 0.5rem; background: white; border-radius: 3px; overflow-x: auto;">
                ${this.escapeHtml(question.sample_output)}
              </div>
            </div>
          </div>
        </div>

        <div style="border-top: 2px solid #eee; padding-top: 1.5rem;">
          <button onclick="BatchQuestions.generateHiddenTestCases('${question.id}')" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; width: 100%; margin-bottom: 1rem;">
            Generate Hidden Test Cases with AI
          </button>
        </div>

        <div style="margin-top: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h4 style="color: #155724; margin: 0; font-size: 0.95rem;">Saved Hidden Test Cases (${hiddenTestcases.length})</h4>
            <button onclick="BatchQuestions.showAddTestCaseForm('${question.id}', ${hiddenTestcases.length})" style="padding: 0.4rem 0.75rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">+ Add</button>
          </div>
          
          ${hiddenTestcases && hiddenTestcases.length > 0 ? `
            <div style="display: grid; gap: 0.75rem; max-height: 250px; overflow-y: auto;">
              ${hiddenTestcases.map((tc, idx) => `
                <div style="padding: 0.75rem; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <div style="font-weight: 500; color: #0056b3; font-size: 0.9rem;">Test ${idx + 1}</div>
                    <div style="display: flex; gap: 0.25rem;">
                      <button onclick="BatchQuestions.showEditTestCaseForm('${question.id}', ${idx})" style="padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">Edit</button>
                      <button onclick="BatchQuestions.deleteTestCase('${question.id}', ${idx})" style="padding: 0.25rem 0.5rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75rem;">Delete</button>
                    </div>
                  </div>
                  <div style="font-family: monospace; font-size: 0.8rem; color: #555;">
                    <div><strong>Input:</strong><br>${this.escapeHtml((tc.input || tc.test_input || '').substring(0, 80))}</div>
                    <div><strong>Output:</strong><br>${this.escapeHtml((tc.expected_output || '').substring(0, 80))}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div style="color: #999; font-style: italic;">No hidden test cases yet</div>
          `}
        </div>

        <div id="batchQEditTestCasePanel" style="display: none; margin-top: 1rem;"></div>
        <div id="testCaseContainer_${question.id}" style="display: none; margin-top: 1rem;"></div>
      </div>
    `;
    
    let editorHtml = `
      <div style="padding: 1.5rem; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <h4 style="color: #555; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Code</h4>
          <div style="background: #1e1e1e; border-radius: 4px; padding: 1rem; font-family: monospace; color: #d4d4d4; font-size: 0.85rem; height: 200px; overflow: hidden; border: 1px solid #333;">
            <div style="color: #6a9955;">// Write your solution here</div>
            <div style="margin-top: 0.5rem; color: #9cdcfe;">def addTwoNumbers(l1, l2):</div>
            <div style="color: #6a9955; margin-left: 2rem;">pass</div>
          </div>
        </div>

        <div style="border-top: 1px solid #ddd; padding-top: 1rem;">
          <h4 style="color: #555; margin: 0 0 0.75rem 0; font-size: 0.9rem;">Test Cases</h4>
          <div style="background: #f9f9f9; border-radius: 4px; border: 1px solid #ddd; max-height: 150px; overflow-y: auto;">
            ${hiddenTestcases && hiddenTestcases.length > 0 ? `
              ${hiddenTestcases.slice(0, 3).map((tc, idx) => `
                <div style="padding: 0.75rem; border-bottom: 1px solid #eee; font-size: 0.85rem;">
                  <div style="font-weight: 500; color: #333;">Test ${idx + 1}</div>
                  <div style="color: #666; margin-top: 0.25rem;">Input: ${this.escapeHtml((tc.input || tc.test_input || '').substring(0, 40))}...</div>
                </div>
              `).join('')}
              ${hiddenTestcases.length > 3 ? `<div style="padding: 0.5rem; text-align: center; color: #999; font-size: 0.85rem;">+${hiddenTestcases.length - 3} more test cases</div>` : ''}
            ` : `
              <div style="padding: 1rem; text-align: center; color: #999;">No test cases yet</div>
            `}
          </div>
        </div>

        <div style="border-top: 1px solid #ddd; padding-top: 1rem; flex: 1;">
          <h4 style="color: #555; margin: 0 0 0.75rem 0; font-size: 0.9rem;">Output</h4>
          <div style="background: #f5f5f5; border-radius: 4px; border: 1px solid #ddd; padding: 1rem; height: 100%; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #333;">
            <div style="color: #999;">Run code to see output</div>
          </div>
        </div>
      </div>
    `;

    // Create resizable split layout
    const splitLayout = `
      <div id="questionSplitContainer_${question.id}" style="display: flex; height: 100%; width: 100%; gap: 0;">
        <div id="questionDetailsPanel_${question.id}" style="flex: 1; min-width: 300px; background: white; border-right: 1px solid #ddd; overflow: hidden;">
          ${detailsHtml}
        </div>
        
        <div id="resizeHandle_${question.id}" style="width: 4px; background: #ddd; cursor: col-resize; transition: background 0.2s; user-select: none;" 
             onmouseenter="this.style.background='#007bff'" 
             onmouseleave="this.style.background='#ddd'"
             onmousedown="BatchQuestions.startResize(event, '${question.id}')"></div>
        
        <div id="questionEditorPanel_${question.id}" style="flex: 1; min-width: 300px; background: white; overflow: hidden;">
          ${editorHtml}
        </div>
      </div>
    `;

    document.getElementById('batchQuestionDetailPanel').innerHTML = splitLayout;
  },

  /**
   * Clear question detail panel
   */
  clearQuestionDetail: function() {
    const panel = document.getElementById('batchQuestionDetailPanel');
    if (panel) {
      panel.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Select a question to view details</div>';
    }
  },

  /**
   * Start resizing the split panels
   */
  startResize: function(event, questionId) {
    event.preventDefault();
    const container = document.getElementById(`questionSplitContainer_${questionId}`);
    const detailsPanel = document.getElementById(`questionDetailsPanel_${questionId}`);
    const startX = event.clientX;
    const startLeftWidth = detailsPanel.offsetWidth;
    const containerWidth = container.offsetWidth;

    const onMouseMove = (e) => {
      const diff = e.clientX - startX;
      const newLeftWidth = startLeftWidth + diff;
      const minWidth = 300;
      const maxWidth = containerWidth - 300;

      if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
        const percentage = (newLeftWidth / containerWidth) * 100;
        detailsPanel.style.flex = `0 0 ${percentage}%`;
      }
    };

    const onMouseUp = () => {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  },

  /**
   * Delete confirmation dialog
   */
  deleteConfirm: function(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
      this.delete(questionId);
    }
  },

  /**
   * Delete a question
   */
  delete: async function(questionId) {
    try {
      const response = await fetch(`${this.apiEndpoint}/${questionId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        Utils.showMessage('batchMessage', 'Question deleted successfully', 'success');
        this.clearForm();
        this.loadQuestions();
      } else {
        const error = await response.json();
        Utils.showMessage('batchMessage', error.message || 'Error deleting question', 'error');
      }
    } catch (error) {
      console.error('Error deleting question:', error);
      Utils.showMessage('batchMessage', 'Error deleting question', 'error');
    }
  },

  /**
   * Generate hidden test cases using AI agent
   */
  generateHiddenTestCases: async function(questionId) {
    const question = this.allQuestions.find(q => q.id === questionId);
    
    if (!question) {
      Utils.showMessage('batchMessage', 'Question not found', 'error');
      return;
    }

    // Validate required fields
    const required = ['description', 'sample_input', 'sample_output'];
    const missing = required.filter(field => !question[field]);
    
    if (missing.length > 0) {
      Utils.showMessage('batchMessage', `Question missing required fields: ${missing.join(', ')}`, 'error');
      return;
    }

    try {
      // Show loading state - store button reference before async
      const btn = document.querySelector(`button[onclick="BatchQuestions.generateHiddenTestCases('${questionId}')"]`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Generating Test Cases...';
      }

      Utils.showMessage('batchMessage', 'Generating test cases using AI agent...', 'info');

      const response = await fetch(`${CONFIG.API_BASE_URL}/batch/generate-testcases`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          question_id: questionId,
          description: question.description,
          sample_input: question.sample_input,
          sample_output: question.sample_output
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Test case generation failed');
      }

      const testcases = data.data?.testcases || data.testcases || [];
      
      if (!testcases || testcases.length === 0) {
        Utils.showMessage('batchMessage', 'No test cases were generated', 'warning');
      } else {
        this.displayGeneratedTestCases(questionId, testcases);
        Utils.showMessage('batchMessage', `Generated ${testcases.length} hidden test cases successfully`, 'success');
      }

    } catch (error) {
      console.error('Generate test cases error:', error);
      Utils.showMessage('batchMessage', 'Failed to generate test cases: ' + error.message, 'error');
    } finally {
      const btn = document.querySelector(`button[onclick="BatchQuestions.generateHiddenTestCases('${questionId}')"]`);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Generate Hidden Test Cases with AI';
      }
    }
  },

  /**
   * Display generated test cases in detail panel
   */
  displayGeneratedTestCases: function(questionId, testcases) {
    const container = document.getElementById(`testCaseContainer_${questionId}`);
    if (!container) return;

    let html = `
      <div style="padding: 1rem; background: #f0f8ff; border-radius: 4px; border-left: 4px solid #28a745;">
        <h4 style="margin-top: 0; color: #155724;">Generated Hidden Test Cases (${testcases.length})</h4>
        <p style="font-size: 0.85rem; color: #666; margin: 0 0 1rem 0;">These test cases will be hidden from students and used for evaluation.</p>
        <div style="display: grid; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
    `;

    testcases.forEach((tc, index) => {
      html += `
        <div style="padding: 0.75rem; background: white; border: 1px solid #dee2e6; border-radius: 4px;">
          <div style="font-weight: 500; color: #333; margin-bottom: 0.5rem;">Test Case ${index + 1}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.85rem;">
            <div>
              <span style="color: #666; font-size: 0.8rem; font-weight: 500;">Input:</span>
              <div style="font-family: monospace; color: #333; background: #f9f9f9; padding: 0.5rem; border-radius: 3px; word-break: break-all; margin-top: 0.25rem;">
                ${this.escapeHtml(tc.input || tc.test_input || 'N/A')}
              </div>
            </div>
            <div>
              <span style="color: #666; font-size: 0.8rem; font-weight: 500;">Expected Output:</span>
              <div style="font-family: monospace; color: #333; background: #f9f9f9; padding: 0.5rem; border-radius: 3px; word-break: break-all; margin-top: 0.25rem;">
                ${this.escapeHtml(tc.expected_output || 'N/A')}
              </div>
            </div>
          </div>
        </div>
      `;
    });

    html += `
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
          <button onclick="BatchQuestions.saveHiddenTestCases('${questionId}')" style="flex: 1; padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
            Save Hidden Test Cases
          </button>
          <button onclick="document.getElementById('testCaseContainer_${questionId}').style.display = 'none';" style="flex: 1; padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Close
          </button>
        </div>
      </div>
    `;

    container.innerHTML = html;
    container.style.display = 'block';

    // Store testcases in memory for saving later
    this.pendingTestCases = { questionId, testcases };
  },

  /**
   * Save hidden test cases to question
   */
  saveHiddenTestCases: async function(questionId) {
    if (!this.pendingTestCases || this.pendingTestCases.questionId !== questionId) {
      Utils.showMessage('batchMessage', 'No test cases to save', 'error');
      return;
    }

    try {
      Utils.showMessage('batchMessage', 'Saving hidden test cases...', 'info');

      const response = await fetch(`${this.apiEndpoint}/${questionId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          hidden_testcases: this.pendingTestCases.testcases
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to save test cases');
      }

      Utils.showMessage('batchMessage', 'Hidden test cases saved successfully', 'success');
      this.pendingTestCases = null;
      document.getElementById(`testCaseContainer_${questionId}`).style.display = 'none';
      
      // Reload questions to update display
      await this.loadQuestions();

    } catch (error) {
      console.error('Save test cases error:', error);
      Utils.showMessage('batchMessage', 'Failed to save test cases: ' + error.message, 'error');
    }
  },

  /**
   * Show form to add new test case
   */
  showAddTestCaseForm: function(questionId, testCaseNum) {
    const panel = document.getElementById('batchQEditTestCasePanel');
    if (!panel) return;

    const self = this;
    let html = '<div style="background: #e8f5e9; border: 1px solid #81c784; border-radius: 4px; padding: 1rem;">';
    html += '<h5 style="margin: 0 0 0.75rem 0; color: #2e7d32;">Add New Test Case</h5>';
    html += '<div style="margin-bottom: 0.75rem;"><label style="font-size: 0.85rem; font-weight: bold;">Input:</label>';
    html += '<textarea id="bqnewtcinput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 0.8rem; min-height: 60px; box-sizing: border-box;"></textarea></div>';
    html += '<div style="margin-bottom: 0.75rem;"><label style="font-size: 0.85rem; font-weight: bold;">Expected Output:</label>';
    html += '<textarea id="bqnewtcoutput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 0.8rem; min-height: 60px; box-sizing: border-box;"></textarea></div>';
    html += '<div style="display: flex; gap: 0.5rem;">';
    html += '<button id="bqsavenewtc" style="padding: 0.5rem 1rem; background: #4caf50; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem; flex: 1;">Add Test Case</button>';
    html += '<button id="bqcancnewtc" style="padding: 0.5rem 1rem; background: #999; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem; flex: 1;">Cancel</button>';
    html += '</div></div>';

    panel.innerHTML = html;
    panel.style.display = 'block';

    document.getElementById('bqsavenewtc').addEventListener('click', function() {
      self.saveNewTestCaseBatch(questionId);
    });

    document.getElementById('bqcancnewtc').addEventListener('click', function() {
      panel.style.display = 'none';
    });
  },

  /**
   * Show form to edit test case
   */
  showEditTestCaseForm: function(questionId, tcIdx) {
    const question = this.allQuestions.find(q => q.id === questionId);
    if (!question) return;
    
    const testcase = question.hidden_testcases[tcIdx];
    const panel = document.getElementById('batchQEditTestCasePanel');
    if (!panel) return;

    const self = this;
    let html = '<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 1rem;">';
    html += '<h5 style="margin: 0 0 0.75rem 0; color: #856404;">Edit Test Case ' + (tcIdx + 1) + '</h5>';
    html += '<div style="margin-bottom: 0.75rem;"><label style="font-size: 0.85rem; font-weight: bold;">Input:</label>';
    html += '<textarea id="bqedittcinput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 0.8rem; min-height: 60px; box-sizing: border-box;">' + this.escapeHtml(testcase.input || testcase.test_input || '') + '</textarea></div>';
    html += '<div style="margin-bottom: 0.75rem;"><label style="font-size: 0.85rem; font-weight: bold;">Expected Output:</label>';
    html += '<textarea id="bqedittcoutput" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 0.8rem; min-height: 60px; box-sizing: border-box;">' + this.escapeHtml(testcase.expected_output || '') + '</textarea></div>';
    html += '<div style="display: flex; gap: 0.5rem;">';
    html += '<button id="bqsaveedittc" style="padding: 0.5rem 1rem; background: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem; flex: 1;">Update Test Case</button>';
    html += '<button id="bqcancedittc" style="padding: 0.5rem 1rem; background: #999; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem; flex: 1;">Cancel</button>';
    html += '</div></div>';

    panel.innerHTML = html;
    panel.style.display = 'block';

    document.getElementById('bqsaveedittc').addEventListener('click', function() {
      self.saveEditTestCaseBatch(questionId, tcIdx);
    });

    document.getElementById('bqcancedittc').addEventListener('click', function() {
      panel.style.display = 'none';
    });
  },

  /**
   * Save new test case
   */
  saveNewTestCaseBatch: async function(questionId) {
    const input = document.getElementById('bqnewtcinput').value.trim();
    const output = document.getElementById('bqnewtcoutput').value.trim();

    if (!input || !output) {
      alert('Please fill in both input and output');
      return;
    }

    const question = this.allQuestions.find(q => q.id === questionId);
    if (!question) return;

    const testcases = question.hidden_testcases || [];
    testcases.push({ input, expected_output: output });

    try {
      const response = await fetch(this.apiEndpoint + '/' + questionId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ hidden_testcases: testcases })
      });

      if (!response.ok) throw new Error('Save failed');

      alert('Test case added successfully');
      document.getElementById('batchQEditTestCasePanel').style.display = 'none';
      await this.loadQuestions();
    } catch (error) {
      alert('Failed to add test case: ' + error.message);
    }
  },

  /**
   * Save edited test case
   */
  saveEditTestCaseBatch: async function(questionId, tcIdx) {
    const input = document.getElementById('bqedittcinput').value.trim();
    const output = document.getElementById('bqedittcoutput').value.trim();

    if (!input || !output) {
      alert('Please fill in both input and output');
      return;
    }

    const question = this.allQuestions.find(q => q.id === questionId);
    if (!question) return;

    const testcases = question.hidden_testcases || [];
    if (tcIdx >= 0 && tcIdx < testcases.length) {
      testcases[tcIdx] = { input, expected_output: output };
    }

    try {
      const response = await fetch(this.apiEndpoint + '/' + questionId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ hidden_testcases: testcases })
      });

      if (!response.ok) throw new Error('Save failed');

      alert('Test case updated successfully');
      document.getElementById('batchQEditTestCasePanel').style.display = 'none';
      await this.loadQuestions();
    } catch (error) {
      alert('Failed to update test case: ' + error.message);
    }
  },

  /**
   * Delete test case
   */
  deleteTestCase: async function(questionId, tcIdx) {
    if (!confirm('Delete this test case?')) return;

    const question = this.allQuestions.find(q => q.id === questionId);
    if (!question) return;

    const testcases = question.hidden_testcases || [];
    testcases.splice(tcIdx, 1);

    try {
      const response = await fetch(this.apiEndpoint + '/' + questionId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({ hidden_testcases: testcases })
      });

      if (!response.ok) throw new Error('Save failed');

      alert('Test case deleted successfully');
      await this.loadQuestions();
    } catch (error) {
      alert('Failed to delete test case: ' + error.message);
    }
  },

  /**
   * XSS Prevention: Escape HTML characters
   */
  escapeHtml: function(text) {
    if (!text) return '';
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
};

// Tab switching - load questions when Questions tab is clicked
document.addEventListener('DOMContentLoaded', function() {
  const batchTabButtons = document.querySelectorAll('[data-batch-tab]');
  
  batchTabButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      if (this.getAttribute('data-batch-tab') === 'questions') {
        BatchQuestions.init();
      }
    });
  });
});

// Export for global access
window.BatchQuestions = BatchQuestions;



